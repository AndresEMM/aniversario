<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mapa de Aventura — Compañía de Dos Lunas</title>

<!-- GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<!-- tsParticles (luciérnagas) -->
<script src="https://cdn.jsdelivr.net/npm/tsparticles@2.8.0/tsparticles.bundle.min.js"></script>
<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Great+Vibes&display=swap" rel="stylesheet">

<style>
:root{
  --paper-base:#f2e9d0;
  --paper-top:#f9f3e2;
  --ink:#2b2419;
  --gold:#e0c06c;
  --pin:#b5179e;
  --pin-muted:#5e5a69;
  --route:#5a4226;
  --halo:#ffdd88;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  color:var(--ink);
  font-family:"Cinzel", serif;
  background:#0a0d14;
  overflow:hidden;
}

/* Fondo pergamino + viñeta */
.bg{
  position:fixed; inset:0; z-index:-3;
  background:
    radial-gradient(120% 100% at 50% 15%, rgba(255,255,255,.25), transparent 60%),
    linear-gradient(180deg, var(--paper-top), var(--paper-base));
}
.vignette{
  position:fixed; inset:0; z-index:-2; pointer-events:none;
  background:
    radial-gradient(80% 60% at 50% 40%, transparent 0%, rgba(0,0,0,.18) 70%, rgba(0,0,0,.4) 100%);
}
#tsparticles{position:fixed; inset:0; z-index:-1}

header{
  position:fixed; top:12px; left:0; right:0; text-align:center;
  padding:8px 12px; pointer-events:none;
}
h1{
  display:inline-block; pointer-events:auto;
  font-family:"Great Vibes", cursive;
  font-size:clamp(1.8rem, 3.6vw, 3rem);
  color:var(--gold);
  text-shadow:0 0 16px rgba(224,192,108,.35);
  padding:4px 10px;
}
.sub{
  margin-top:4px; font-size:.95rem; opacity:.85;
}

.controls{
  position:fixed; top:12px; right:12px; display:flex; gap:8px;
}
.btn{
  border:none; cursor:pointer; padding:8px 12px; border-radius:999px;
  font-weight:700; letter-spacing:.4px; color:#1a140e; background: #f0e3c3;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
}
.btn:hover{ filter:brightness(1.04) }
.progress{
  position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
  background:#f0e6cc; padding:6px 12px; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,.18);
  font-weight:700;
}

/* Contenedor mapa */
.map-wrap{
  position:fixed; inset:0; display:grid; place-items:center; padding:40px 16px 56px;
}
.map{
  width:min(1100px, 92vw);
  max-height:78vh;
  aspect-ratio: 12 / 7; /* mantiene proporción del viewBox */
  border-radius:16px;
  box-shadow:inset 0 0 0 2px rgba(0,0,0,.06), inset 0 0 60px rgba(122,92,46,.15);
  background:
    radial-gradient(140% 90% at 50% 10%, rgba(255,255,255,.18), transparent 60%),
    repeating-linear-gradient(25deg, rgba(0,0,0,.025) 0 12px, transparent 12px 24px);
}

/* Ruta */
.route{ fill:none; stroke:var(--route); stroke-width:6; stroke-linecap:round; opacity:.85 }

/* Pines */
.pin{ cursor:default }
.pin circle.main{
  fill:white; stroke:var(--pin-muted); stroke-width:3;
}
.pin circle.ring{
  fill:none; stroke:var(--pin-muted); stroke-width:2; opacity:.65;
}
.pin text{
  font-size:20px; font-weight:700; fill:var(--ink);
  text-shadow:0 2px 0 rgba(255,255,255,.5);
}
.pin.active circle.main{
  stroke:var(--pin); filter: drop-shadow(0 0 10px rgba(181,23,158,.55));
}
.pin.active circle.ring{
  stroke:var(--halo); animation: pulse 1.6s ease-in-out infinite;
}
.pin.done circle.main{ stroke:#2e7d32 }
.pin.done circle.ring{ stroke:#9ee3a0; opacity:.8 }

@keyframes pulse{
  0%,100%{ stroke-width:2; opacity:.6 }
  50%{ stroke-width:5; opacity:1 }
}

.lock{ pointer-events:none; opacity:.65 }

/* Modal evento */
.modal{
  position:fixed; inset:0; display:none; place-items:center;
  background: rgba(0,0,0,.5); backdrop-filter: blur(3px);
  z-index:10; padding:16px;
}
.modal.active{ display:grid }
.card{
  width:min(640px, 92vw);
  background: radial-gradient(120% 90% at 20% 0%, rgba(224,192,108,.12), transparent 60%),
              linear-gradient(180deg, #faf2da, #f1e5c7);
  border:1px solid rgba(0,0,0,.1); border-radius:18px; padding:16px 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,.35);
}
.card h2{
  font-size:1.3rem; margin-bottom:6px; color:#3a2b18;
}
.card p{
  font-size:1.05rem; line-height:1.6; color:#2b2419;
}
.card .foot{
  display:flex; gap:8px; justify-content:flex-end; margin-top:12px;
}
.card .foot .btn{ background:#e9dbb7 }

/* Final overlay */
#final{
  position:fixed; inset:0; display:none; place-items:center;
  background: radial-gradient(120% 80% at 50% 30%, rgba(224,192,108,.08), transparent 60%),
              rgba(6,7,12,.86);
  color:#f8efe0; text-align:center; padding:18px; z-index:12;
}
#final.active{ display:grid }
#final h3{
  font-family:"Great Vibes", cursive;
  font-size: clamp(2rem, 6vw, 3.6rem);
  color: var(--gold);
  text-shadow: 0 0 16px rgba(224,192,108,.35);
  margin-bottom: 10px;
}
#final p{
  font-size:clamp(1rem,2.4vw,1.2rem); line-height:1.7; max-width:760px; margin:0 auto;
}

/* Accesibilidad en teclado */
.pin[tabindex="0"]:focus circle.main{ outline: none; stroke:#000; stroke-width:3 }
</style>
</head>
<body>

<div class="bg"></div>
<div class="vignette"></div>
<div id="tsparticles"></div>

<header>
  <h1>Mapa de la Aventura — Dos Lunas</h1>
  <div class="sub">Haz clic en el <strong>pin brillante</strong> para avanzar</div>
</header>

<div class="controls">
  <button class="btn" id="reset">Reiniciar</button>
</div>

<div class="map-wrap">
  <!-- SVG Mapa -->
  <svg class="map" viewBox="0 0 1200 700" role="img" aria-label="Mapa de aventura">
    <!-- (Opcional) decoración tenue -->
    <g opacity=".12">
      <path d="M70,500 Q200,360 360,440 T650,360 T980,280" fill="none" stroke="#000" stroke-width="40" />
      <circle cx="1020" cy="460" r="120" fill="#000"/>
      <path d="M850,160 l40,-80 l40,80 z" fill="#000"/>
      <path d="M220,200 l30,-60 l30,60 z" fill="#000"/>
    </g>

    <!-- Rutas: se crean por JS (segmentos dibujados) -->
    <g id="routes"></g>

    <!-- Pines -->
    <g id="pins">
      <!-- Se posicionan por JS; este g sólo sirve de contenedor -->
    </g>
  </svg>
</div>

<div class="progress"><span id="progText">Progreso 0/5</span></div>

<!-- Modal evento -->
<div class="modal" id="modal">
  <div class="card">
    <h2 id="evtTitle"></h2>
    <p id="evtText"></p>
    <div class="foot">
      <button class="btn" id="close">Cerrar</button>
      <button class="btn" id="continuar">Continuar</button>
    </div>
  </div>
</div>

<!-- Mensaje final -->
<div id="final">
  <div>
    <h3>¡Ruta completada! ✨</h3>
    <p>
      Gracias por venir conmigo. Me encanta este viaje: punto a punto, risa a risa,
      bajo los mismos cielos. <br>
      <em>Sigamos dibujando el mapa… la próxima vez hay más aventura.</em>
    </p>
  </div>
</div>

<script>
/* ==========================
   Partículas (luciérnagas)
   ========================== */
tsParticles.load("tsparticles", {
  fpsLimit: 60,
  background: { color: "transparent" },
  particles: {
    number: { value: 60 },
    move: { enable: true, speed: 0.4, direction: "none", outModes: { default:"out" } },
    opacity: { value: {min:.4, max:.9} },
    size: { value: { min: 1.5, max: 3.5 } },
    color: { value: ["#ffd166","#fff4b0","#ffe07a"] },
    twinkle: { particles: { enable: true, frequency: 0.05, opacity: 1 } },
    shape: { type: "circle" }
  },
  interactivity: {
    events: { onHover: { enable: true, mode: "attract" } },
    modes: { attract: { distance: 120, duration: 0.2, factor: 1.2 } }
  }
});

/* ==========================
   Datos del mapa
   ========================== */
const STOPS = [
  {
    id:"pueblo", label:"Posada «Dos Lunas»", x:150, y:540,
    title:"La Posada",
    text:"Aquí empezó nuestro ‘sí’ suave: panes tibios, un par de canciones y el mapa todavía en blanco. Yo guardé tu risa; tú me guardaste a mí."
  },
  {
    id:"bosque", label:"Bosque Susurrante", x:360, y:420,
    title:"El Bosque",
    text:"Hicimos un conjuro pequeñito: decirnos las verdades con calma. Entre hojas y luciérnagas, aprendimos un hechizo de risa."
  },
  {
    id:"puente", label:"Puente de la Distancia", x:560, y:360,
    title:"El Puente",
    text:"La distancia es un mapa: lo cruzamos con paciencia, mensajes y ganas. Cada tabla del puente cruje distinto, pero aguanta nuestros pasos."
  },
  {
    id:"torre", label:"Torre de la Luna Gemela", x:820, y:220,
    title:"La Torre",
    text:"Desde lo alto vimos el mismo cielo en dos ciudades. Y fue fácil: bastó mirar y saber que estábamos en la misma historia."
  },
  {
    id:"bahia", label:"Bahía del Reencuentro", x:1040, y:420,
    title:"La Bahía",
    text:"Aquí las olas dicen ‘hasta pronto’. Guardamos este trocito de ruta para abrirlo juntos. Te quiero, y me gusta este camino contigo."
  }
];

const svg = document.querySelector(".map");
const pinsLayer = document.getElementById("pins");
const routesLayer = document.getElementById("routes");
const progText = document.getElementById("progText");

const modal = document.getElementById("modal");
const evtTitle = document.getElementById("evtTitle");
const evtText = document.getElementById("evtText");
const btnClose = document.getElementById("close");
const btnCont = document.getElementById("continuar");
const btnReset = document.getElementById("reset");
const finalOverlay = document.getElementById("final");

let current = 0; // índice del pin activo
let segments = []; // <path> de rutas
let pinNodes = []; // grupos <g> de pines

/* ==========================
   Crear pins y rutas
   ========================== */
function createPins(){
  STOPS.forEach((s, i)=>{
    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.classList.add("pin");
    g.setAttribute("transform", `translate(${s.x},${s.y})`);
    g.setAttribute("data-index", i);
    g.setAttribute("tabindex","0");
    // anillo
    const ring = document.createElementNS("http://www.w3.org/2000/svg","circle");
    ring.setAttribute("r","18"); ring.setAttribute("class","ring");
    // cuerpo
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("r","12"); c.setAttribute("class","main");
    // etiqueta
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x","0"); t.setAttribute("y","-24");
    t.setAttribute("text-anchor","middle");
    t.textContent = s.label;

    g.appendChild(ring); g.appendChild(c); g.appendChild(t);
    pinsLayer.appendChild(g);
    pinNodes.push(g);
  });
}

function curvePath(x1,y1,x2,y2){
  // curva suave: control en el punto medio con desplazamiento
  const mx = (x1+x2)/2;
  const my = (y1+y2)/2;
  const dx = x2 - x1;
  const dy = y2 - y1;
  // Desplaza el control perpendicular a la recta para darle curvita
  const len = Math.hypot(dx,dy) || 1;
  const nx = -dy/len, ny = dx/len;
  const bend = 60; // curvatura
  const cx = mx + nx * bend;
  const cy = my + ny * bend;
  return `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
}

function createRoutes(){
  for(let i=0;i<STOPS.length-1;i++){
    const a = STOPS[i], b = STOPS[i+1];
    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("d", curvePath(a.x, a.y, b.x, b.y));
    p.setAttribute("class","route");
    // preparar para animación de “dibujo”
    const len = p.getTotalLength();
    p.style.strokeDasharray = len;
    p.style.strokeDashoffset = len;
    routesLayer.appendChild(p);
    segments.push(p);
  }
}

/* ==========================
   Estado / UI
   ========================== */
function setActivePin(index){
  pinNodes.forEach((g,i)=>{
    g.classList.remove("active","done","lock");
    if(i < index){ g.classList.add("done"); }
    else if(i === index){ g.classList.add("active"); g.style.cursor="pointer"; }
    else { g.classList.add("lock"); g.style.cursor="default"; }
  });
  progText.textContent = `Progreso ${Math.min(index, STOPS.length)}/${STOPS.length}`;
}

function openEvent(index){
  const s = STOPS[index];
  evtTitle.textContent = `${s.title} — ${s.label}`;
  evtText.textContent = s.text;
  modal.classList.add("active");
  // pequeña entrada
  gsap.fromTo(".card",{opacity:0, y:10, scale:.98},{opacity:1, y:0, scale:1, duration:.35, ease:"power2.out"});
}

function closeEvent(){
  gsap.to(".card",{opacity:0, y:8, scale:.98, duration:.25, ease:"power1.in", onComplete:()=>{
    modal.classList.remove("active");
  }});
}

function drawNextSegment(i){
  if(i >= segments.length) return Promise.resolve();
  const seg = segments[i];
  return new Promise(res=>{
    gsap.to(seg, { strokeDashoffset: 0, duration: 1.2, ease: "power2.out", onComplete: res });
  });
}

function burstConfetti(){
  confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 } });
}

/* ==========================
   Interacciones
   ========================== */
function onPinClick(e){
  const g = e.currentTarget;
  const i = +g.getAttribute("data-index");
  if(i !== current) return; // sólo el activo
  openEvent(i);
}
function onPinKey(e){
  if((e.key==="Enter"||e.key===" ") && +e.currentTarget.getAttribute("data-index")===current){
    openEvent(current);
  }
}

function nextStep(){
  closeEvent();
  // marcar como hecho, dibujar tramo y activar siguiente
  drawNextSegment(current).then(()=>{
    burstConfetti();
    current += 1;
    if(current < STOPS.length){
      setActivePin(current);
    }else{
      // fin
      document.querySelectorAll(".route").forEach(r=>r.style.opacity=1);
      finalOverlay.classList.add("active");
      // confetti un poquito más
      setTimeout(()=>confetti({ particleCount: 180, spread: 80, origin: { y: .7 } }), 200);
    }
  });
}

function resetAll(){
  current = 0;
  // reset rutas
  segments.forEach(p=>{
    const len = p.getTotalLength();
    p.style.strokeDasharray = len;
    p.style.strokeDashoffset = len;
  });
  setActivePin(current);
  finalOverlay.classList.remove("active");
}

/* ==========================
   Init
   ========================== */
createPins();
createRoutes();
setActivePin(0);

// Listeners
pinNodes.forEach(g=>{
  g.addEventListener("click", onPinClick);
  g.addEventListener("keydown", onPinKey);
});

btnClose.addEventListener("click", closeEvent);
btnCont.addEventListener("click", nextStep);
btnReset.addEventListener("click", resetAll);

// Accesibilidad: cerrar modal clic fuera
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeEvent(); });

</script>
</body>
</html>
